USE [D365Migration]
GO
/****** Object:  StoredProcedure [dbo].[OnHandInventoryJournalHeaders_GPToD365DB]    Script Date: 3/21/2022 2:51:36 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER Procedure [dbo].[OnHandInventoryJournalHeaders_GPToD365DB]
as

INSERT INTO [dbo].OnHandInventoryJournalHeaders
           ([DataAreaId]
           ,[journalnumber],
		   [JournalNameId]
           ,[DefaultINVENTORYSITEID],
		   [DefaultWAREHOUSEID])
	 (
select distinct 
	'GICT',
    'IMOV-' + CAST ( (dense_rank() OVER(ORDER BY I2.locncode)) AS NVARCHAR(10)) AS JournalNumber,
	'IMOV' as JournalNameId,
	'10' AS INVENTORYSITEID, 
	case
		when i2.LOCNCODE like 'new%'
			then '100'
		else i2.LOCNCODE
	end as INVENTORYWAREHOUSEID

from gwc.dbo.IV00102 i2
join gwc.dbo.iv00101 i1
on i1.ITEMNMBR = i2.ITEMNMBR
join gwc.dbo.GL00105 gl5
on gl5.ACTINDX = i1.IVIVINDX
where i1.ITEMTYPE = 1
AND I1.ITMCLSCD != 'Delete'
and i2.QTYONHND != 0
and i2.RCRDTYPE = 2
and ACTNUMST like '180%'
and i2.LOCNCODE != '1102'
group by i2.ITEMNMBR, i2.LOCNCODE, gl5.ACTNUMST
)