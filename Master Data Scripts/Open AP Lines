USE [D365Migration]
GO
/****** Object:  StoredProcedure [dbo].[OpenAPLines_GPToD365DB]    Script Date: 4/12/2022 3:40:39 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER  Procedure [dbo].[OpenAPLines_GPToD365DB]
as

INSERT INTO [dbo].[OpenAPLines]
           ([DataAreaId]
           ,[JournalBatchNumber]
           ,[LineNumber]
           ,[Credit]
           ,[Invoice]
           ,[InvoiceDate]
           ,[DueDate]
           ,[Voucher]
           ,[AccountDisplayValue]
           ,[AccountType]
           ,[TermsOfPayment]
           ,[Currency],
		   DefaultDimensionDisplayValue,
		   OFFSETACCOUNTDISPLAYVALUE,
		   	PostingProfile,
			ApprovedBy,
			Approved)
(
select 
'GICT',
(select  journalbatchnumber from openAPHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'gict') as JournalBatchNumber,
row_number() over ( partition by BACHNUMB order by bachnumb ) as LineNumber,
P.DOCAMNT AS CREDIT, 
p.DOCNUMBR as INVOICE,
P.INVOICERECEIPTDATE AS INVOICEDATE,
p.DUEDATE,
p.VCHRNMBR as voucher,
p.VENDORID as accountdisplayvalue,
'vend' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
'000000-9999-Proj0000-1' as DefaultDimensionDisplayValue,
 '21100-000000-9999-Proj0000-1' as OFFSETACCOUNTDISPLAYVALUE,
 'General' as PostingProfile,
 '00001' as Approvedby,
 1 as Approved
--bring them over with today's date, just try to use their voucher numbers, currency USD
from gwc.dbo.PM20000 p
where p.DOCTYPE = 1

union
select 
'GTS',
(select  journalbatchnumber from openAPHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'gts') as JournalBatchNumber,
row_number() over ( partition by BACHNUMB order by bachnumb ) as LineNumber,
P.DOCAMNT AS CREDIT, 
p.DOCNUMBR as INVOICE,
P.INVOICERECEIPTDATE AS INVOICEDATE,
p.DUEDATE,
p.VCHRNMBR as voucher,
p.VENDORID as accountdisplayvalue,
'vend' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
'000000-9999-Proj0000-1' as DefaultDimensionDisplayValue,
 '21100-000000-9999-Proj0000-1' as OFFSETACCOUNTDISPLAYVALUE,
 'General' as PostingProfile,
 '00001' as Approvedby,
 1 as Approved
--bring them over with today's date, just try to use their voucher numbers, currency USD
from gss.dbo.PM20000 p
where p.DOCTYPE = 1

union

select 
'Blue',
(select  journalbatchnumber from openAPHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'Blue') as JournalBatchNumber,
row_number() over ( partition by BACHNUMB order by bachnumb ) as LineNumber,
P.DOCAMNT AS CREDIT, 
p.DOCNUMBR as INVOICE,
P.INVOICERECEIPTDATE AS INVOICEDATE,
p.DUEDATE,
p.VCHRNMBR as voucher,
p.VENDORID as accountdisplayvalue,
'vend' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
'000000-9999-Proj0000-1' as DefaultDimensionDisplayValue,
 '21100-000000-9999-Proj0000-1' as OFFSETACCOUNTDISPLAYVALUE,
 'General' as PostingProfile,
 '00001' as Approvedby,
 1 as Approved

--bring them over with today's date, just try to use their voucher numbers, currency USD
from BLUE.dbo.PM20000 p
where p.DOCTYPE = 1

)



