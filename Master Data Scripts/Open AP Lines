USE [D365Migration]
GO
/****** Object:  StoredProcedure [dbo].[OpenAPLines_GPToD365DB]    Script Date: 5/6/2022 5:21:22 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER  Procedure [dbo].[OpenAPLines_GPToD365DB]
as

INSERT INTO [dbo].[OpenAPLines]
           ([DataAreaId]
           ,[JournalBatchNumber]
           ,[LineNumber]
           ,[Credit]
		   ,Debit
           ,[Invoice]
           ,[InvoiceDate]
           ,[DueDate]
           ,[Voucher]
           ,[AccountDisplayValue]
           ,[AccountType]
           ,[TermsOfPayment]
           ,[Currency],
		   DefaultDimensionDisplayValue,
		   OFFSETACCOUNTDISPLAYVALUE,
		   	PostingProfile,
			ApprovedBy,
			Approved)
(
select 
'GICT',
(select  journalbatchnumber from openAPHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'gict') as JournalBatchNumber,
row_number() over ( partition by BACHNUMB order by bachnumb ) as LineNumber,
pm.CRDTAMNT,
pm.DEBITAMT,
p.DOCNUMBR as INVOICE,
P.INVOICERECEIPTDATE AS INVOICEDATE,
p.DUEDATE,
p.VCHRNMBR as voucher,
v.vendoraccountnumber as accountdisplayvalue,
'vend' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
concat(m1.d365mainaccount, '-', m2.d365department, '-','9999-1-Proj0000') as DefaultDimensionDisplayValue,
concat(m1.d365mainaccount, '-', m2.d365department, '-','9999-1-Proj0000')  as OFFSETACCOUNTDISPLAYVALUE,
 'General' as PostingProfile,
 '00001' as Approvedby,
 1 as Approved
--bring them over with today's date, just try to use their voucher numbers, currency USD
from  gwc.dbo.pm20000 p
join D365Migration.dbo.vendors v
on v.OurAccountNumber = p.VENDORID
and dataareaid = 'gict'
join gwc.dbo.PM10100 pm
on pm.VCHRNMBR = p.VCHRNMBR
join gwc.dbo.gl00100 g
on pm.DSTINDX = g.ACTINDX
join D365Migration.dbo.mainaccountmapping m1
on m1.gpmainaccount = Trim(G.ACTNUMBR_1)
and m1.dataareaid = 'gict'
join d365migration.dbo.departmentmapping m2
	on m2.gpdepartment =  trim(G.ACTNUMBR_2)


union
select 
'GTS',
(select  journalbatchnumber from openAPHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'GTS') as JournalBatchNumber,
row_number() over ( partition by BACHNUMB order by bachnumb ) as LineNumber,
pm.CRDTAMNT,
pm.DEBITAMT,
p.DOCNUMBR as INVOICE,
P.INVOICERECEIPTDATE AS INVOICEDATE,
p.DUEDATE,
p.VCHRNMBR as voucher,
v.vendoraccountnumber as accountdisplayvalue,
'vend' as AccountType,
case
	when p.PYMTRMID like '1%'
		then '1% 20 Days/N30'
	else p.PYMTRMID
end as TermsOfPayment,
'USD' as Currency,
concat(m1.d365mainaccount, '-', m2.d365department, '-','9999-1-Proj0000') as DefaultDimensionDisplayValue,
concat(m1.d365mainaccount, '-', m2.d365department, '-','9999-1-Proj0000')  as OFFSETACCOUNTDISPLAYVALUE,
 'General' as PostingProfile,
 '00001' as Approvedby,
 1 as Approved
--bring them over with today's date, just try to use their voucher numbers, currency USD
from  gss.dbo.pm20000 p
join D365Migration.dbo.vendors v
on v.OurAccountNumber = p.VENDORID
and dataareaid = 'GTS'
join gss.dbo.PM10100 pm
on pm.VCHRNMBR = p.VCHRNMBR
join gss.dbo.gl00100 g
on pm.DSTINDX = g.ACTINDX
join D365Migration.dbo.mainaccountmapping m1
on m1.gpmainaccount = Trim(G.ACTNUMBR_1)
and m1.dataareaid = 'GTS'
join d365migration.dbo.departmentmapping m2
	on m2.gpdepartment =  trim(G.ACTNUMBR_2)

union
select 
'blue',
(select  journalbatchnumber from openAPHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'blue') as JournalBatchNumber,
row_number() over ( partition by BACHNUMB order by bachnumb ) as LineNumber,
pm.CRDTAMNT,
pm.DEBITAMT,
p.DOCNUMBR as INVOICE,
P.INVOICERECEIPTDATE AS INVOICEDATE,
p.DUEDATE,
p.VCHRNMBR as voucher,
v.vendoraccountnumber as accountdisplayvalue,
'vend' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
concat(m1.d365mainaccount, '-', m2.d365department, '-','9999-1-Proj0000') as DefaultDimensionDisplayValue,
concat(m1.d365mainaccount, '-', m2.d365department, '-','9999-1-Proj0000')  as OFFSETACCOUNTDISPLAYVALUE,
 'General' as PostingProfile,
 '00001' as Approvedby,
 1 as Approved
--bring them over with today's date, just try to use their voucher numbers, currency USD
from  blue.dbo.pm20000 p
join D365Migration.dbo.vendors v
on v.OurAccountNumber = p.VENDORID
and dataareaid = 'blue'
join blue.dbo.PM10100 pm
on pm.VCHRNMBR = p.VCHRNMBR
join blue.dbo.gl00100 g
on pm.DSTINDX = g.ACTINDX
join D365Migration.dbo.mainaccountmapping m1
on m1.gpmainaccount = Trim(G.ACTNUMBR_1)
and m1.dataareaid = 'blue'
join d365migration.dbo.departmentmapping m2
	on m2.gpdepartment =  trim(G.ACTNUMBR_2)

)



