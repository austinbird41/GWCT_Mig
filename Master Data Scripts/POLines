USE [D365Migration]
GO
/****** Object:  StoredProcedure [dbo].[PurchaseOrderLines_GPToD365DB]    Script Date: 5/11/2022 3:45:03 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER Procedure [dbo].[PurchaseOrderLines_GPToD365DB] as

INSERT INTO [dbo].[PURCHASEORDERLines]
           ([DataAreaId]
           ,[PurchaseOrderNumber]
		   ,linenumber
           ,[ItemNumber]
           ,[ReceivingWarehouseId]
           ,[PurchaseUnitSymbol]
           ,PurchasePrice
           ,[DeliveryAddressStreet]
           ,[DeliveryAddressCity]
           ,[DeliveryAddressStateID]
           ,[DeliveryAddressZipCode]
           ,[DeliveryAddressCountryRegionIsoCode]
           ,[DeliveryAddressCountryRegionId]
           ,[DeliveryAddressDescription]
           ,[ORDEREDPURCHASEQUANTITY]
           ,PROCUREMENTPRODUCTCATEGORYNAME,
		   LineDescription,
		   GWCTCANCELDATE,
		   DEFAULTLEDGERDIMENSIONDISPLAYVALUE)
select 'GICT' as DataAreaId, poLine.PONUMBER as PURCHASEORDERNUMBER,
poline.LineNumber,
--poline.POLNESTA as PURCHASEORDERLINESTATUS,
case
		when poline.ITEMNMBR in (select ItemNumber
									from ReleasedProducts)
			then poline.ITEMNMBR
		else ''
end as ItemNumber,
case
		when poline.ITEMNMBR not in (select ItemNumber from ReleasedProducts) 
			then ''
		when poLine.LOCNCODE like 'new%' and poline.ITEMNMBR in (select ItemNumber from ReleasedProducts)
			then '100'


end as ReceivingWarehouseId,
case
	when poLine.UOFM = 'each'
		then 'ea'
	else poLine.UOFM
end as PurchaseUnitSymbol,
poline.unitcost   as PURCHASEPRICE,
--poline.FREEONBOARD, --not sure what this is
--poline.Change_Order_Flag, --needed?
concat(poline.ADDRESS1,poline.address2, poline.address3) as DeliveryAddressStreet,
poline.city as DeliveryAddressCity,
poline.STATE as DeliveryAddressStateID,
poline.ZIPCODE as DeliveryAddressZipCode,
poline.CCode as DeliveryAddressCountryRegionIsoCode,
case
	when poline.country = ''
		then 'USA'
	else poline.country
end as DeliveryAddressCountryRegionId,
'Goodwill Industries Central Texas' as DeliveryAddressDescription,
--Quantity fields
poline.QTYORDER as ORDEREDPURCHASEQUANTITY
--poline.QTYCANCE, --quantity cancelled?
--poline.QTYUNCMTBASE --quantity uncommitted in base?
--date fields?
--Other questions
--are comments/notes needed?
--are costing fields needed?
, case
		when poline.ITEMNMBR not in (select ItemNumber
									from ReleasedProducts)
			then 'Migration-PO'
		else ''
	end as PROCUREMENTPRODUCTCATEGORYNAME
,poline.ITEMDESC as LineDescription
,poHeader.CONTENDDTE as GWCTCANCELDATE
,concat('-', d.d365department,'-9999-1-Proj0000') as DEFAULTLEDGERDIMENSIONDISPLAYVALUE
from gwc.dbo.POP10110 poLine 
join gwc.dbo.pop10100 poHeader
on poLine.PONUMBER = poHeader.ponumber
left join D365Migration.dbo.departmentmapping d
 on d.GPDepartment = trim (poline.locncode)
where poHeader.POSTATUS in  (1,2,3)
and poheader.VENDORID != ''


Union

select 'GTS' as DataAReaId, poLine.PONUMBER as PURCHASEORDERNUMBER,
poline.LineNumber,
--poline.POLNESTA as PURCHASEORDERLINESTATUS,
case
		when poline.ITEMNMBR in (select ItemNumber
									from ReleasedProducts)
			then poline.ITEMNMBR
		else ''
end as ItemNumber,
--poLine.VENDORID as VendorNumber,
--poLine.VNDITNUM, --needed?
--poLine.NONINVEN, --noninventory, needed?
case
		when poline.ITEMNMBR not in (select ItemNumber from ReleasedProducts) 
			then ''
		when poLine.LOCNCODE like 'new%' and poline.ITEMNMBR in (select ItemNumber from ReleasedProducts)
			then '100'
end as ReceivingWarehouseId,
case
	when poLine.UOFM = 'each'
		then 'ea'
	else poLine.UOFM
end as PurchaseUnitSymbol,
poline.unitcost   as PURCHASEPRICE,
--poline.FREEONBOARD, --not sure what this is
--poline.Change_Order_Flag, --needed?
concat(poline.ADDRESS1,poline.address2, poline.address3) as DeliveryAddressStreet,
poline.city as DeliveryAddressCity,
poline.STATE as DeliveryAddressStateID,
poline.ZIPCODE as DeliveryAddressZipCode,
poline.CCode as DeliveryAddressCountryRegionIsoCode,
case
	when poline.country = ''
		then 'USA'
	else poline.country
end as DeliveryAddressCountryRegionId,
'Goodwill Industries Central Texas' as DeliveryAddressDescription,
--Quantity fields
poline.QTYORDER as ORDEREDPURCHASEQUANTITY
--poline.QTYCANCE, --quantity cancelled?
--poline.QTYUNCMTBASE --quantity uncommitted in base?
--date fields?
--Other questions
--are comments/notes needed?
--are costing fields needed?
, case
		when poline.ITEMNMBR not in (select ItemNumber
									from ReleasedProducts)
			then 'Migration-PO'
		else ''
	end as PROCUREMENTPRODUCTCATEGORYNAME
	,poline.ITEMDESC as LineDescription
,poHeader.CONTENDDTE as GWCTCANCELDATE
,concat('-', d.d365department,'-9999-1-Proj0000') as DEFAULTLEDGERDIMENSIONDISPLAYVALUE
from gss.dbo.POP10110 poLine
join gss.dbo.pop10100 poHeader
on poLine.PONUMBER = poHeader.ponumber
left join D365Migration.dbo.departmentmapping d
 on d.GPDepartment = trim (poline.locncode)
where poHeader.POSTATUS in  (1,2,3)
and poheader.VENDORID != ''

Union

select 'BLUE' as DataAreaId, poLine.PONUMBER as PURCHASEORDERNUMBER,
poline.LineNumber,
--poline.POLNESTA as PURCHASEORDERLINESTATUS,
case
		when poline.ITEMNMBR in (select ItemNumber
									from ReleasedProducts)
			then poline.ITEMNMBR
		else ''
end as ItemNumber,
case
		when poline.ITEMNMBR not in (select ItemNumber from ReleasedProducts) 
			then ''
		when poLine.LOCNCODE like 'new%' and poline.ITEMNMBR in (select ItemNumber from ReleasedProducts)
			then '100'
end as ReceivingWarehouseId,
case
	when poLine.UOFM = 'each'
		then 'ea'
	else poLine.UOFM
end as PurchaseUnitSymbol,
poline.unitcost   as PURCHASEPRICE,
--poline.FREEONBOARD, --not sure what this is
--poline.Change_Order_Flag, --needed?
concat(poline.ADDRESS1,poline.address2, poline.address3) as DeliveryAddressStreet,
poline.city as DeliveryAddressCity,
poline.STATE as DeliveryAddressStateID,
poline.ZIPCODE as DeliveryAddressZipCode,
poline.CCode as DeliveryAddressCountryRegionIsoCode,
case
	when poline.country = ''
		then 'USA'
	else poline.country
end as DeliveryAddressCountryRegionId,
'Goodwill Industries Central Texas' as DeliveryAddressDescription,
--Quantity fields
poline.QTYORDER as ORDEREDPURCHASEQUANTITY
--poline.QTYCANCE, --quantity cancelled?
--poline.QTYUNCMTBASE --quantity uncommitted in base?
--date fields?
--Other questions
--are comments/notes needed?
--are costing fields needed?
, case
		when poline.ITEMNMBR not in (select ItemNumber
									from ReleasedProducts)
			then 'Migration-PO'
		else ''
	end as PROCUREMENTPRODUCTCATEGORYNAME
,poline.ITEMDESC as LineDescription
,poHeader.CONTENDDTE as GWCTCANCELDATE
,concat('-', d.d365department,'-9999-1-Proj0000') as DEFAULTLEDGERDIMENSIONDISPLAYVALUE
from blue.dbo.POP10110 poLine
join blue.dbo.pop10100 poHeader
on poLine.PONUMBER = poHeader.ponumber
left join D365Migration.dbo.departmentmapping d
 on d.GPDepartment = trim (poline.locncode)
where poHeader.POSTATUS in  (1,2,3)
and poheader.VENDORID != ''

Union

select 'GWFD' as DataAreaId, 
poLine.PONUMBER as PURCHASEORDERNUMBER,
poline.LineNumber,
--poline.POLNESTA as PURCHASEORDERLINESTATUS,
case
		when poline.ITEMNMBR in (select ItemNumber
									from ReleasedProducts)
			then poline.ITEMNMBR
		else ''
end as ItemNumber,
case
		when poline.ITEMNMBR not in (select ItemNumber from ReleasedProducts) 
			then ''
		when poLine.LOCNCODE like 'new%' and poline.ITEMNMBR in (select ItemNumber from ReleasedProducts)
			then '100'
end as ReceivingWarehouseId,
case
	when poLine.UOFM = 'each'
		then 'ea'
	else poLine.UOFM
end as PurchaseUnitSymbol,
poline.unitcost   as PURCHASEPRICE,
--poline.FREEONBOARD, --not sure what this is
--poline.Change_Order_Flag, --needed?
concat(poline.ADDRESS1,poline.address2, poline.address3) as DeliveryAddressStreet,
poline.city as DeliveryAddressCity,
poline.STATE as DeliveryAddressStateID,
poline.ZIPCODE as DeliveryAddressZipCode,
poline.CCode as DeliveryAddressCountryRegionIsoCode,
case
	when poline.country = ''
		then 'USA'
	else poline.country
end as DeliveryAddressCountryRegionId,
'Goodwill Industries Central Texas' as DeliveryAddressDescription,
--Quantity fields
poline.QTYORDER as ORDEREDPURCHASEQUANTITY
--poline.QTYCANCE, --quantity cancelled?
--poline.QTYUNCMTBASE --quantity uncommitted in base?
--date fields?
--Other questions
--are comments/notes needed?
--are costing fields needed?
, case
		when poline.ITEMNMBR not in (select ItemNumber
									from ReleasedProducts)
			then 'Migration-PO'
		else ''
	end as PROCUREMENTPRODUCTCATEGORYNAME
,poline.ITEMDESC as LineDescription
,poHeader.CONTENDDTE as GWCTCANCELDATE
,concat('-', d.d365department,'-9999-1-Proj0000') as DEFAULTLEDGERDIMENSIONDISPLAYVALUE
from excel.dbo.POP10110 poLine
join excel.dbo.pop10100 poHeader
on poLine.PONUMBER = poHeader.ponumber
left join D365Migration.dbo.departmentmapping d
 on d.GPDepartment = trim (poline.locncode)
where poHeader.POSTATUS in  (1,2,3)
and poheader.VENDORID != ''







