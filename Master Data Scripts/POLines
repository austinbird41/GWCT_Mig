USE [D365Migration]
GO
/****** Object:  StoredProcedure [dbo].[PurchaseOrderLines_GPToD365DB]    Script Date: 6/30/2022 3:30:30 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER Procedure [dbo].[PurchaseOrderLines_GPToD365DB] as

INSERT INTO [dbo].[PURCHASEORDERLines]
           ([DataAreaId]
           ,[PurchaseOrderNumber]
		   ,linenumber
           ,[ItemNumber]
           ,[ReceivingWarehouseId]
           ,[PurchaseUnitSymbol]
           ,PurchasePrice
           ,[DeliveryAddressStreet]
           ,[DeliveryAddressCity]
           ,[DeliveryAddressStateID]
           ,[DeliveryAddressZipCode]
           ,[DeliveryAddressCountryRegionIsoCode]
           ,[DeliveryAddressCountryRegionId]
           ,[DeliveryAddressDescription]
           ,[ORDEREDPURCHASEQUANTITY]
           ,PROCUREMENTPRODUCTCATEGORYNAME,
		   LineDescription,
		   GWCTCANCELDATE,
		   DEFAULTLEDGERDIMENSIONDISPLAYVALUE)
select 'GICT' as DataAreaId, poLine.PONUMBER as PURCHASEORDERNUMBER,
poline.LineNumber,
--poline.POLNESTA as PURCHASEORDERLINESTATUS,
case
		when poline.ITEMNMBR in (select ItemNumber
									from ReleasedProducts)
			then poline.ITEMNMBR
		else ''
end as ItemNumber,
case
		when trim(poline.ITEMNMBR) not in (select ItemNumber from ReleasedProducts) 
			then ''
		when poLine.LOCNCODE like 'new%' and poline.ITEMNMBR in (select ItemNumber from ReleasedProducts)
			then '100'

		else ''
end as ReceivingWarehouseId,
case
	when poLine.UOFM = 'each'
		then 'ea'
	else poLine.UOFM
end as PurchaseUnitSymbol,
poline.unitcost   as PURCHASEPRICE
--poline.FREEONBOARD, --not sure what this is
--poline.Change_Order_Flag, --needed?
,concat(trim(poheader.address1),' ', trim(poheader.address2),' ', trim(poheader.address3)) AS DELIVERYADDRESSSTREET
,poheader.city DELIVERYADDRESSCITY
,poheader.state as DELIVERYADDRESSSTATEID
,poheader.ZIPCODE as DELIVERYADDRESSZIPCODE
,case
	when poheader.CCode = ''
		then 'usa'
	else poheader.CCode
end as DELIVERYADDRESSCOUNTRYREGIONISOCODE
,poheader.country as DELIVERYADDRESSCOUNTRYREGIONID
,poheader.vendname as DeliveryAddressDescription,
--Quantity fields
poline.QTYUNCMTBASE as ORDEREDPURCHASEQUANTITY
--poline.QTYCANCE, --quantity cancelled?
--poline.QTYUNCMTBASE --quantity uncommitted in base?
--date fields?
--Other questions
--are comments/notes needed?
--are costing fields needed?
, case
		when trim(poline.ITEMNMBR) not in (select ItemNumber
									from ReleasedProducts)
			then 'Migration-PO'
		else ''
	end as PROCUREMENTPRODUCTCATEGORYNAME
,poline.itemnmbr as LineDescription
,poHeader.CONTENDDTE as GWCTCANCELDATE
,case
	when trim(poline.locncode) = 'newgoods'
		then '-160000-1-9999--Proj999999' 
	else concat('-', d.d365department,'-1-9999--Proj999999') 
end as DEFAULTLEDGERDIMENSIONDISPLAYVALUE
from gwc.dbo.POP10110 poLine 
join gwc.dbo.pop10100 poHeader
on poLine.PONUMBER = poHeader.ponumber
left join D365Migration.dbo.departmentmapping d
 on d.GPDepartment = trim (poline.locncode)
where poHeader.POSTATUS in  (1,2,3)
and poheader.VENDORID != ''
and (poline.QTYUNCMTBASE  >0)



Union

select 'GTS' as DataAReaId, poLine.PONUMBER as PURCHASEORDERNUMBER,
poline.LineNumber,
--poline.POLNESTA as PURCHASEORDERLINESTATUS,
case
		when poline.ITEMNMBR in (select ItemNumber
									from ReleasedProducts)
			then poline.ITEMNMBR
		else ''
end as ItemNumber,
--poLine.VENDORID as VendorNumber,
--poLine.VNDITNUM, --needed?
--poLine.NONINVEN, --noninventory, needed?
case
		when trim(poline.ITEMNMBR) not in (select ItemNumber from ReleasedProducts) 
			then ''
		when poLine.LOCNCODE like 'new%' and poline.ITEMNMBR in (select ItemNumber from ReleasedProducts)
			then '100'
		else ''
end as ReceivingWarehouseId,
case
	when poLine.UOFM = 'each'
		then 'ea'
	else poLine.UOFM
end as PurchaseUnitSymbol,
poline.unitcost   as PURCHASEPRICE
--poline.FREEONBOARD, --not sure what this is
--poline.Change_Order_Flag, --needed?
,concat(trim(poheader.address1),' ', trim(poheader.address2),' ', trim(poheader.address3)) AS DELIVERYADDRESSSTREET
,poheader.city DELIVERYADDRESSCITY
,poheader.state as DELIVERYADDRESSSTATEID
,poheader.ZIPCODE as DELIVERYADDRESSZIPCODE
,case
	when poheader.CCode = ''
		then 'usa'
	else poheader.CCode
end as DELIVERYADDRESSCOUNTRYREGIONISOCODE
,poheader.country as DELIVERYADDRESSCOUNTRYREGIONID
,poheader.vendname as DeliveryAddressDescription,
--Quantity fields
poline.QTYUNCMTBASE as ORDEREDPURCHASEQUANTITY
--poline.QTYCANCE, --quantity cancelled?
--poline.QTYUNCMTBASE --quantity uncommitted in base?
--date fields?
--Other questions
--are comments/notes needed?
--are costing fields needed?
, case
		when trim(poline.ITEMNMBR) not in (select ItemNumber
									from ReleasedProducts)
			then 'Migration-PO'
		else ''
	end as PROCUREMENTPRODUCTCATEGORYNAME
	,poline.itemnmbr as LineDescription
,poHeader.CONTENDDTE as GWCTCANCELDATE
,case
	when trim(poline.locncode) = 'newgoods'
		then '-160000-1-9999--' 
	else concat('-', d.d365department,'-1-9999--') 
end as DEFAULTLEDGERDIMENSIONDISPLAYVALUE
from gss.dbo.POP10110 poLine
join gss.dbo.pop10100 poHeader
on poLine.PONUMBER = poHeader.ponumber
left join D365Migration.dbo.departmentmapping d
 on d.GPDepartment = trim (poline.locncode)
where poHeader.POSTATUS in  (1,2,3)
and poheader.VENDORID != ''
and (poline.QTYUNCMTBASE  >0)

Union

select 'BLUE' as DataAreaId, poLine.PONUMBER as PURCHASEORDERNUMBER,
poline.LineNumber,
--poline.POLNESTA as PURCHASEORDERLINESTATUS,
case
		when poline.ITEMNMBR in (select ItemNumber
									from ReleasedProducts)
			then poline.ITEMNMBR
		else ''
end as ItemNumber,
case
		when trim(poline.ITEMNMBR) not in (select ItemNumber from ReleasedProducts) 
			then ''
		when poLine.LOCNCODE like 'new%' and poline.ITEMNMBR in (select ItemNumber from ReleasedProducts)
			then '100'
				else ''
end as ReceivingWarehouseId,
case
	when poLine.UOFM = 'each'
		then 'ea'
	else poLine.UOFM
end as PurchaseUnitSymbol,
poline.unitcost   as PURCHASEPRICE
--poline.FREEONBOARD, --not sure what this is
--poline.Change_Order_Flag, --needed?
,concat(trim(poheader.address1),' ', trim(poheader.address2),' ', trim(poheader.address3)) AS DELIVERYADDRESSSTREET
,poheader.city DELIVERYADDRESSCITY
,poheader.state as DELIVERYADDRESSSTATEID
,poheader.ZIPCODE as DELIVERYADDRESSZIPCODE
,case
	when poheader.CCode = ''
		then 'usa'
	else poheader.CCode
end as DELIVERYADDRESSCOUNTRYREGIONISOCODE
,poheader.country as DELIVERYADDRESSCOUNTRYREGIONID
,poheader.vendname as DeliveryAddressDescription,
--Quantity fields
poline.QTYUNCMTBASE as ORDEREDPURCHASEQUANTITY
, case
		when trim(poline.ITEMNMBR) not in (select ItemNumber
									from ReleasedProducts)
			then 'Migration-PO'
		else ''
	end as PROCUREMENTPRODUCTCATEGORYNAME
,poline.itemnmbr as LineDescription
,poHeader.CONTENDDTE as GWCTCANCELDATE
,case
	when trim(poline.locncode) = 'newgoods'
		then '-160000-1-9999--' 
	else concat('-', d.d365department,'-1-9999--') 
end as DEFAULTLEDGERDIMENSIONDISPLAYVALUE
from blue.dbo.POP10110 poLine
join blue.dbo.pop10100 poHeader
on poLine.PONUMBER = poHeader.ponumber
left join D365Migration.dbo.departmentmapping d
 on d.GPDepartment = trim (poline.locncode)
where poHeader.POSTATUS in  (1,2,3)
and poheader.VENDORID != ''
and (poline.QTYUNCMTBASE  >0)

Union

select 'EXCL' as DataAreaId, 
poLine.PONUMBER as PURCHASEORDERNUMBER,
poline.LineNumber,
--poline.POLNESTA as PURCHASEORDERLINESTATUS,
case
		when poline.ITEMNMBR in (select ItemNumber
									from ReleasedProducts)
			then poline.ITEMNMBR
		else ''
end as ItemNumber,
case
		when trim(poline.ITEMNMBR) not in (select ItemNumber from ReleasedProducts) 
			then ''
		when poLine.LOCNCODE like 'new%' and poline.ITEMNMBR in (select ItemNumber from ReleasedProducts)
			then '100'
				else ''
end as ReceivingWarehouseId,
case
	when poLine.UOFM = 'each'
		then 'ea'
	else poLine.UOFM
end as PurchaseUnitSymbol,
poline.unitcost   as PURCHASEPRICE
--poline.FREEONBOARD, --not sure what this is
--poline.Change_Order_Flag, --needed?
,concat(trim(poheader.address1),' ', trim(poheader.address2),' ', trim(poheader.address3)) AS DELIVERYADDRESSSTREET
,poheader.city DELIVERYADDRESSCITY
,poheader.state as DELIVERYADDRESSSTATEID
,poheader.ZIPCODE as DELIVERYADDRESSZIPCODE
,case
	when poheader.CCode = ''
		then 'usa'
	else poheader.CCode
end as DELIVERYADDRESSCOUNTRYREGIONISOCODE
,poheader.country as DELIVERYADDRESSCOUNTRYREGIONID
,poheader.vendname as DeliveryAddressDescription,
--Quantity fields
poline.QTYUNCMTBASE as ORDEREDPURCHASEQUANTITY
--poline.QTYCANCE, --quantity cancelled?
--poline.QTYUNCMTBASE --quantity uncommitted in base?
--date fields?
--Other questions
--are comments/notes needed?
--are costing fields needed?
, case
		when trim(poline.ITEMNMBR) not in (select ItemNumber
									from ReleasedProducts)
			then 'Migration-PO'
		else ''
	end as PROCUREMENTPRODUCTCATEGORYNAME
,poline.itemnmbr as LineDescription
,poHeader.CONTENDDTE as GWCTCANCELDATE
,case
	when trim(poline.locncode) = 'newgoods'
		then '-160000-1-9999--' 
	else concat('-', d.d365department,'-1-9999--') 
end as DEFAULTLEDGERDIMENSIONDISPLAYVALUE
from excel.dbo.POP10110 poLine
join excel.dbo.pop10100 poHeader
on poLine.PONUMBER = poHeader.ponumber
left join D365Migration.dbo.departmentmapping d
 on d.GPDepartment = trim (poline.locncode)
where poHeader.POSTATUS in  (1,2,3)
and poheader.VENDORID != ''
and (poline.QTYUNCMTBASE  >0)







