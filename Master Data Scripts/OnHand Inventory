USE [D365Migration]
GO
/****** Object:  StoredProcedure [dbo].[OnHandInventory_GPToD365DB]    Script Date: 3/25/2022 4:17:53 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
ALTER Procedure [dbo].[OnHandInventory_GPToD365DB]
as

INSERT INTO [dbo].[OnHandInventory]
           ([DataAreaId]
           ,[journalnumber]
           ,[LineNumber],
		   itemnumber
           ,[INVENTORYSITEID]
           ,[INVENTORYWAREHOUSEID]
           ,[WarehouseLocationID]
           ,[InventoryQuantity]
           ,[JournalNameId],
		   UnitCost)
	 (
select 
	'GICT',
    (select top 1 journalnumber from onhandinventoryjournalheaders where defaultwarehouseid=i2.LOCNCODE) AS JournalNumber,
	'' as LineNumber,
	i2.ITEMNMBR as ItemNumber, 
	'10' AS INVENTORYSITEID, 
		case
		when i2.LOCNCODE like 'new%'
			then '100'
		else i2.LOCNCODE
	end as INVENTORYWAREHOUSEID,
    '' as WarehouseLocationID,
    sum(i2.QTYONHND) as InventoryQuantity,
	'IMOV' as JournalNameId,
	i1.CURRCOST as UnitCost
	--'' as LicensePlateNumber,
	--gl5.ACTNUMST --DefaultledgerDimensionDisplayValue
from gwc.dbo.IV00102 i2
join gwc.dbo.iv00101 i1
on i1.ITEMNMBR = i2.ITEMNMBR
join gwc.dbo.GL00105 gl5
on gl5.ACTINDX = i1.IVIVINDX
where i1.ITEMTYPE = 1
AND I1.ITMCLSCD != 'Delete'
and i2.QTYONHND != 0
and i2.RCRDTYPE = 2
and ACTNUMST like '180%'
and i2.LOCNCODE !='1102'
group by i2.ITEMNMBR, i2.LOCNCODE, i1.CURRCOST
)