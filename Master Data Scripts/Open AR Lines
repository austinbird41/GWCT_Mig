USE [D365Migration]
GO
/****** Object:  StoredProcedure [dbo].[OpenARLines_GPToD365DB]    Script Date: 7/5/2022 2:19:52 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER Procedure [dbo].[OpenARLines_GPToD365DB]
as
INSERT INTO [dbo].[OpenARLines]
           ([DataAreaId]
           ,[JournalBatchNumber]
           ,[LineNumber]
           ,[DebitAmount],
		   [CreditAmount]
           ,[InvoiceId]
           ,[DueDate]
           ,[CustomerAccountDisplayValue]
           ,[AccountType]
           ,[TermsOfPayment]
           ,[Currency]
           ,[OffsetAccountDisplayValue]
		   ,DEFAULTDIMENSIONDISPLAYVALUE,
		   approved,
		   InvoiceDate, DocumentDate,
		   TransactionText, PaymReference)
(
select 
'GICT',
(select  journalbatchnumber from openARHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'gict') as JournalBatchNumber,
dense_rank() over (partition by BACHNUMB order by DOCNUMBR)  as LineNumber,
case
	when RMDTYPAL IN (1,3)
		then p.CURTRXAM
	else 0
end as debitamount,
case
	when RMDTYPAL IN (7,9)
		then p.CURTRXAM
	else 0
end as creditamount,
p.DOCNUMBR as INVOICEID,
p.DUEDATE, 
--p. as voucher,
trim(p.CUSTNMBR) as Customeraccountdisplayvalue,
'Customer' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
 '12110-000000-1-9999--Proj999999' as OFFSETACCOUNTDISPLAYVALUE,
 '12110-000000-1-9999--Proj999999' as DEFAULTDIMENSIONDISPLAYVALUE,
 1
 ,p.DOCDATE
  ,p.DOCDATE
  ,''
  ,p.CHEKNMBR
from GWC.dbo.RM20101 p
where p.CURTRXAM != 0
and (trim(p.CUSTNMBR) in (select trim(c.SalesAccountNumber) from D365Migration.dbo.customers c where trim(c.SalesAccountNumber) = trim(p.CUSTNMBR) and c.DataAreaId = 'gict') or 
trim(p.CUSTNMBR) in ('A149', 'C011', 'c100', 'c102', 'c103', 'c141', 'c142', 'd002', 'g482', 'g483', 'p055', 't112', 't114', 't132', 't133', 't143', 't115'))


/*
1-Sales/Invoice = debit
3-debit memos = debit
7-credit memos = credit
9-payments = credit
*/

union

select 
'Blue',
(select  journalbatchnumber from openARHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'blue') as JournalBatchNumber,
dense_rank() over (partition by BACHNUMB order by DOCNUMBR)  as LineNumber,
case
	when RMDTYPAL IN (1,3)
		then p.CURTRXAM
	else 0
end as debitamount,
case
	when RMDTYPAL IN (7,9)
		then p.CURTRXAM
	else 0
end as creditamount,
p.DOCNUMBR as INVOICEID,
p.DUEDATE, 
--p. as voucher,
trim(p.CUSTNMBR) as Customeraccountdisplayvalue,
'Customer' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
 '12110-000000-1-9999--Proj999999' as OFFSETACCOUNTDISPLAYVALUE,
 '12110-000000-1-9999--Proj999999' as DEFAULTDIMENSIONDISPLAYVALUE,
 1
 ,p.DOCDATE
  ,p.DOCDATE
  ,''
  ,p.CHEKNMBR
from blue.dbo.RM20101 p
where p.CURTRXAM != 0
and (trim(p.CUSTNMBR) in (select trim(c.SalesAccountNumber) from D365Migration.dbo.customers c where trim(c.SalesAccountNumber) = trim(p.CUSTNMBR) and c.DataAreaId = 'blue') or 
trim(p.CUSTNMBR) in ('A149', 'C011', 'c100', 'c102', 'c103', 'c141', 'c142', 'd002', 'g482', 'g483', 'p055', 't112', 't114', 't132', 't133', 't143', 't115'))



union
select 
'GTS',
(select  journalbatchnumber from openARHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'gts') as JournalBatchNumber,
dense_rank() over (partition by BACHNUMB order by DOCNUMBR)  as LineNumber,
case
	when RMDTYPAL IN (1,3)
		then p.CURTRXAM
	else 0
end as debitamount,
case
	when RMDTYPAL IN (7,9)
		then p.CURTRXAM
	else 0
end as creditamount,
p.DOCNUMBR as INVOICEID,
p.DUEDATE, 
--p. as voucher,
trim(p.CUSTNMBR) as Customeraccountdisplayvalue,
'Customer' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
 '12110-000000-1-9999--Proj999999' as OFFSETACCOUNTDISPLAYVALUE,
 '12110-000000-1-9999--Proj999999' as DEFAULTDIMENSIONDISPLAYVALUE,
 1
 ,p.DOCDATE
  ,p.DOCDATE
  ,''
  ,p.CHEKNMBR
from gss.dbo.RM20101 p
where p.CURTRXAM != 0
and (trim(p.CUSTNMBR) in (select trim(c.SalesAccountNumber) from D365Migration.dbo.customers c where trim(c.SalesAccountNumber) = trim(p.CUSTNMBR) and c.DataAreaId = 'gts') or 
trim(p.CUSTNMBR) in ('A149', 'C011', 'c100', 'c102', 'c103', 'c141', 'c142', 'd002', 'g482', 'g483', 'p055', 't112', 't114', 't132', 't133', 't143', 't115'))

)
