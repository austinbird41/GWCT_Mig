USE [D365Migration]
GO
/****** Object:  StoredProcedure [dbo].[OpenARLines_GPToD365DB]    Script Date: 5/10/2022 1:39:26 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER Procedure [dbo].[OpenARLines_GPToD365DB]
as
INSERT INTO [dbo].[OpenARLines]
           ([DataAreaId]
           ,[JournalBatchNumber]
           ,[LineNumber]
           ,[DebitAmount],
		   [CreditAmount]
           ,[InvoiceId]
           ,[DueDate]
           ,[CustomerAccountDisplayValue]
           ,[AccountType]
           ,[TermsOfPayment]
           ,[Currency]
           ,[OffsetAccountDisplayValue]
		   ,DEFAULTDIMENSIONDISPLAYVALUE,
		   approved,
		   InvoiceDate, DocumentDate)
(
select 
'GICT',
(select  journalbatchnumber from openARHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'gict') as JournalBatchNumber,
row_number() over ( partition by BACHNUMB order by bachnumb ) as LineNumber,
case
	when RMDTYPAL IN (1,3)
		then p.ORTRXAMT
	else 0
end as debitamount,
case
	when RMDTYPAL IN (7,9)
		then p.ORTRXAMT
	else 0
end as creditamount,
p.DOCNUMBR as INVOICEID,
p.DUEDATE, 
--p. as voucher,
c.CustomerAccount as Customeraccountdisplayvalue,
'Customer' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
 '12110-000000-9999-1-Proj0000' as OFFSETACCOUNTDISPLAYVALUE,
 '12110-000000-9999-1-Proj0000' as DEFAULTDIMENSIONDISPLAYVALUE,
 1
 ,p.DOCDATE
  ,p.DOCDATE
from GWC.dbo.RM20101 p
join D365Migration.dbo.customers c
on c.SalesAccountNumber = p.CUSTNMBR
and c.DataAreaId = 'gict'



/*
1-Sales/Invoice = debit
3-debit memos = debit
7-credit memos = credit
9-payments = credit
*/

union

select 
'Blue',
(select  journalbatchnumber from openARHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'blue') as JournalBatchNumber,
row_number() over (order by DOCNUMBR)  as LineNumber,
case
	when RMDTYPAL IN (1,3)
		then p.ORTRXAMT
	else 0
end as debitamount,
case
	when RMDTYPAL IN (7,9)
		then p.ORTRXAMT
	else 0
end as creditamount,
p.DOCNUMBR as INVOICEID,
p.DUEDATE, 
--p. as voucher,
c.CustomerAccount as Customeraccountdisplayvalue,
'Customer' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
 '12110-000000-9999-1-Proj0000' as OFFSETACCOUNTDISPLAYVALUE,
 '12110-000000-9999-1-Proj0000' as DEFAULTDIMENSIONDISPLAYVALUE,
 1
   ,p.DOCDATE
  ,p.DOCDATE
from blue.dbo.RM20101 p
join D365Migration.dbo.customers c
on c.SalesAccountNumber = p.CUSTNMBR
and c.DataAreaId = 'blue'



union
select 
'GTS',
(select  journalbatchnumber from openARHeaders where trim(substring(description, 19, len(description)-1)) = p.BACHNUMB and dataareaid = 'gts') as JournalBatchNumber,
row_number() over (order by DOCNUMBR)  as LineNumber,
case
	when RMDTYPAL IN (1,3)
		then p.ORTRXAMT
	else 0
end as debitamount,
case
	when RMDTYPAL IN (7,9)
		then p.ORTRXAMT
	else 0
end as creditamount,
p.DOCNUMBR as INVOICEID,
p.DUEDATE, 
--p. as voucher,
c.CustomerAccount as Customeraccountdisplayvalue,
'Customer' as AccountType,
p.PYMTRMID as TermsOfPayment,
'USD' as Currency,
 '12110-000000-9999-1-Proj0000' as OFFSETACCOUNTDISPLAYVALUE,
 '12110-000000-9999-1-Proj0000' as DEFAULTDIMENSIONDISPLAYVALUE,
 1
  ,p.DOCDATE
  ,p.DOCDATE
from gss.dbo.RM20101 p
join D365Migration.dbo.customers c
on c.SalesAccountNumber = p.CUSTNMBR
and c.DataAreaId = 'gts'

)
